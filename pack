#!/bin/sh

# script to pack the application contents (files, scripts, etc.) into a .zip file for uploading as a Cloud Function

# fetch the current date
CURRENT_DATE=$(date +%Y-%m-%d)

# fetch the application file basename
BASENAME=$(basename $(pwd))

# count the number of versions of the filename
VERSION_COUNT=$(($(find ./dist -type f -name "*$BASENAME-$CURRENT_DATE*.zip" | wc -l)+1))

# compose the (final) filename
FILENAME=$BASENAME-$CURRENT_DATE-v$VERSION_COUNT.zip

# remove the contents of the build/ directory
rm -rf build/*

# install all dependencies into the build/ directory
pip install -t build/ -r requirements.txt

# copy all application contents to the build/ directory
cp -rf credentials/ src/ tests/ main.py requirements.txt build/

# enter the build/ directory
cd build

# zip the application contents
zip -r ../dist/$FILENAME .

# return to the application root directory
cd ..
